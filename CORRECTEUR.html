<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Correction densit√© √† la Patoche ‚Äî v1.3.1 (compatibilit√© large)</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    :root {
      --bg-grad-a: #667eea;
      --bg-grad-b: #764ba2;
      --text-main: #1f2937;
      --tile-border: #e5e7eb;
      --tile-text: #374151;
      --tile-sub: #6b7280;
      --accent: #667eea;
      --tile-bg-a: #ffffff;
      --tile-bg-b: #f9fafb;
      --alert-bg: #fef3c7;
      --alert-border: #fbbf24;
      --alert-text: #92400e;
    }
    body.dark {
      --bg-grad-a: #0f172a;
      --bg-grad-b: #1f2937;
      --text-main: #e5e7eb;
      --tile-border: #374151;
      --tile-text: #e5e7eb;
      --tile-sub: #9ca3af;
      --accent: #a78bfa;
      --tile-bg-a: #0b1220;
      --tile-bg-b: #0f1526;
      --alert-bg: #3b2f0e;
      --alert-border: #d97706;
      --alert-text: #fcd34d;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, var(--bg-grad-a) 0%, var(--bg-grad-b) 100%);
      min-height: 100vh;
      padding: 20px;
      color: var(--text-main);
      transition: background 0.3s ease;
    }
    .container { max-width: 1200px; margin: 0 auto; }
    header {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      padding: 24px 32px;
      border-radius: 16px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      margin-bottom: 24px;
      display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 16px;
    }
    body.dark header { background: rgba(17, 24, 39, 0.7); }
    h1 {
      font-size: 28px; font-weight: 700;
      background: linear-gradient(135deg, var(--bg-grad-a) 0%, var(--bg-grad-b) 100%);
      -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent;
    }
    .version { font-size: 14px; color: var(--tile-sub); display: flex; gap: 10px; align-items: center;}
    .toggle { display: inline-flex; align-items: center; gap: 8px; font-size: 12px; }
    .card {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 16px; padding: 24px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1); margin-bottom: 24px;
    }
    body.dark .card { background: rgba(17, 24, 39, 0.7); }
    .volume-section { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; align-items: end; }
    .input-group { display: flex; flex-direction: column; gap: 8px; }
    label { font-size: 14px; font-weight: 600; color: var(--tile-text); }
    input[type="text"], input[type="number"] {
      padding: 12px 16px; border: 2px solid var(--tile-border); border-radius: 10px;
      font-size: 16px; transition: all 0.2s; background: white;
    }
    body.dark input[type="text"], body.dark input[type="number"] { background: #0b1220; color: #e5e7eb; border-color: #334155; }
    input[type="text"]:focus, input[type="number"]:focus {
      outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    .preset-buttons { display: flex; gap: 8px; flex-wrap: wrap; }
    .btn {
      padding: 8px 16px; border: none; border-radius: 8px; font-size: 14px; font-weight: 600;
      cursor: pointer; transition: all 0.2s;
    }
    .btn-secondary { background: #f3f4f6; color: #374151; }
    .btn-secondary:hover { background: #e5e7eb; transform: translateY(-1px); }
    body.dark .btn-secondary { background: #0f172a; color: #e5e7eb; }
    body.dark .btn-secondary:hover { background: #111827; }
    .tabs { display: flex; gap: 8px; margin-bottom: 24px; background: rgba(255, 255, 255, 0.5); padding: 6px; border-radius: 12px; }
    body.dark .tabs { background: rgba(17, 24, 39, 0.5); }
    .tab {
      flex: 1; padding: 12px 24px; border: none; border-radius: 8px; font-size: 16px; font-weight: 600;
      cursor: pointer; transition: all 0.3s; background: transparent; color: #6b7280;
    }
    .tab.active { background: white; color: var(--accent); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
    body.dark .tab.active { background: #0b1220; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .og-inputs { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 12px; }
    .helper { font-size: 12px; color: var(--tile-sub); margin-bottom: 12px;}
    .results-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 16px; }
    .info-tile {
      background: linear-gradient(135deg, var(--tile-bg-a) 0%, var(--tile-bg-b) 100%);
      border: 2px solid var(--tile-border); border-radius: 12px; padding: 20px; transition: all 0.3s;
    }
    .info-tile:hover { transform: translateY(-2px); box-shadow: 0 8px 16px rgba(0,0,0,0.1); }
    .info-tile-title { font-size: 12px; text-transform: uppercase; letter-spacing: .5px; color: var(--tile-sub); margin-bottom: 8px; }
    .info-tile-value { font-size: 24px; font-weight: 700; color: var(--accent); margin-bottom: 4px; }
    .info-tile-sub { font-size: 12px; color: var(--tile-sub); }
    .alert { padding: 16px; border-radius: 10px; background: var(--alert-bg); border: 2px solid var(--alert-border); color: var(--alert-text); font-size: 14px; }
    .warning-box { background: var(--alert-bg); border-left: 4px solid var(--alert-border); padding: 12px 16px; border-radius: 8px; font-size: 13px; color: var(--alert-text); margin-top: 16px; }
    .sugar-sliders { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 16px; margin-bottom: 24px; }
    .slider-card { background: linear-gradient(135deg, var(--tile-bg-a) 0%, var(--tile-bg-b) 100%); border: 2px solid var(--tile-border); border-radius: 12px; padding: 20px; }
    .slider-title { font-size: 15px; font-weight: 600; color: var(--tile-text); margin-bottom: 8px; }
    .slider-hint { font-size: 12px; color: var(--tile-sub); margin-bottom: 16px; line-height: 1.5; }
    .slider-container { display: flex; align-items: center; gap: 12px; }
    input[type="range"] { flex: 1; height: 8px; border-radius: 4px; background: #e5e7eb; outline: none; -webkit-appearance: none; padding: 0; border: none; }
    input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; width: 20px; height: 20px; border-radius: 50%; background: linear-gradient(135deg, var(--bg-grad-a) 0%, var(--bg-grad-b) 100%); cursor: pointer; box-shadow: 0 2px 8px rgba(102, 126, 234, 0.4); }
    input[type="range"]::-moz-range-thumb { width: 20px; height: 20px; border-radius: 50%; background: linear-gradient(135deg, var(--bg-grad-a) 0%, var(--bg-grad-b) 100%); cursor: pointer; box-shadow: 0 2px 8px rgba(102, 126, 234, 0.4); border: none; }
    .slider-value { font-size: 16px; font-weight: 700; color: var(--accent); min-width: 50px; text-align: right; }
    .mode-toggle { display:flex; gap:12px; align-items:center; margin:8px 0 16px; font-size:14px; color: var(--tile-text); }
    .inverse-grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(220px,1fr)); gap:16px; margin-bottom: 16px;}
    footer { text-align: center; font-size: 12px; color: rgba(255,255,255,0.8); margin-top: 32px; }
    .js-warning{background:#fee2e2;border:2px solid #ef4444;color:#991b1b;padding:10px;border-radius:10px;margin:0 0 16px 0;font-size:14px}
    @media (max-width: 768px) {
      h1 { font-size: 22px; }
      .results-grid, .sugar-sliders, .inverse-grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body onload="init()">
  <div class="container">
    <header>
      <h1>Correction densit√© √† la Patoche</h1>
      <div class="version">
        <span>v1.3.1 ‚Ä¢ compatibilit√© large</span>
        <label class="toggle">
          <input id="toggle-dark" type="checkbox" onchange="toggleDark(this)"> Mode sombre
        </label>
      </div>
    </header>

    <div id="js-warning" class="js-warning">
      ‚ö†Ô∏è JavaScript ne semble pas actif. Si vous voyez encore ce message apr√®s 2 secondes, ouvrez ce fichier
      directement dans Chrome/Firefox/Edge (pas dans un viewer), ou via http://localhost:8000.
    </div>

    <div class="card">
      <div class="volume-section">
        <div class="input-group">
          <label for="volume">Volume (L)</label>
          <input type="text" id="volume" value="600" placeholder="ex: 600" oninput="calculate()">
        </div>
        <div class="input-group">
          <label>Pr√©r√©glages rapides</label>
          <div class="preset-buttons">
            <button class="btn btn-secondary" onclick="setVolume(450)">450 L</button>
            <button class="btn btn-secondary" onclick="setVolume(500)">500 L</button>
            <button class="btn btn-secondary" onclick="setVolume(550)">550 L</button>
            <button class="btn btn-secondary" onclick="setVolume(600)">600 L</button>
          </div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="tabs">
        <button class="tab active" data-tab="dilution" onclick="switchTab('dilution', this)">üíß Dilution (OG trop haute)</button>
        <button class="tab" data-tab="sugars" onclick="switchTab('sugars', this)">üç¨ Ajout de sucres (OG trop basse)</button>
      </div>

      <!-- TAB DILUTION -->
      <div id="tab-dilution" class="tab-content active">
        <div class="og-inputs">
          <div class="input-group">
            <label for="og-actuelle">Densit√© actuelle (OG)</label>
            <input type="text" id="og-actuelle" value="1.050" placeholder="1.050" oninput="calculate()">
          </div>
          <div class="input-group">
            <label for="og-visee">Densit√© vis√©e (OG)</label>
            <input type="text" id="og-visee" value="1.044" placeholder="1.044" oninput="calculate()">
          </div>
        </div>
        <div class="helper">Astuce : tu peux saisir <b>1044</b> ‚Üí c'est automatiquement compris comme <b>1.044</b>.</div>
        <div id="dilution-results"></div>
        <div class="warning-box">‚ö†Ô∏è L'eau d'appoint doit √™tre st√©rile / bouillie-refroidie</div>
      </div>

      <!-- TAB SUGARS -->
      <div id="tab-sugars" class="tab-content">
        <div class="og-inputs">
          <div class="input-group">
            <label for="og-actuelle-sugar">OG actuelle</label>
            <input type="text" id="og-actuelle-sugar" value="1.040" placeholder="1.040" oninput="calculate()">
          </div>
          <div class="input-group">
            <label for="og-visee-sugar">OG vis√©e</label>
            <input type="text" id="og-visee-sugar" value="1.044" placeholder="1.044" oninput="calculate()">
          </div>
          <div class="info-tile">
            <div class="info-tile-title">Points √† gagner</div>
            <div class="info-tile-value" id="delta-points">‚Äî</div>
          </div>
        </div>

        <div class="mode-toggle">
          <label><input type="radio" name="mode-sugar" value="direct" checked onchange="toggleSugarMode()"> Mode direct (je vise une OG)</label>
          <label><input type="radio" name="mode-sugar" value="inverse" onchange="toggleSugarMode()"> Mode inverse (j'ajoute X g)</label>
        </div>

        <div id="mode-direct">
          <div class="sugar-sliders">
            <div class="slider-card">
              <div class="slider-title">Sucre blanc (saccharose)</div>
              <div class="slider-hint">Fermentescible √† ~100% ‚Üí augmente l'ABV et peut ass√©cher la bi√®re.</div>
              <div class="slider-container">
                <input type="range" id="slider-saccharose" min="0" max="100" value="100" oninput="updateSliderLabel('slider-saccharose','value-saccharose'); calculateSugarsDirect();">
                <div class="slider-value" id="value-saccharose">100%</div>
              </div>
            </div>

            <div class="slider-card">
              <div class="slider-title">Lactose</div>
              <div class="slider-hint">Non fermentescible (par Sacch.) ‚Üí ajoute du corps/rondeur, pas d'ABV.</div>
              <div class="slider-container">
                <input type="range" id="slider-lactose" min="0" max="100" value="0" oninput="updateSliderLabel('slider-lactose','value-lactose'); calculateSugarsDirect();">
                <div class="slider-value" id="value-lactose">0%</div>
              </div>
            </div>

            <div class="slider-card">
              <div class="slider-title">Maltodextrine</div>
              <div class="slider-hint">Quasi non fermentescible ‚Üí ajoute corps/viscosit√©, faible impact ABV.</div>
              <div class="slider-container">
                <input type="range" id="slider-mdx" min="0" max="100" value="0" oninput="updateSliderLabel('slider-mdx','value-mdx'); calculateSugarsDirect();">
                <div class="slider-value" id="value-mdx">0%</div>
              </div>
            </div>
          </div>

          <div class="helper">R√©partis ton ajout entre un, deux ou trois sucres (le total des pourcentages est normalis√© automatiquement).</div>
          <div id="sugar-results"></div>
        </div>

        <div id="mode-inverse" style="display:none;">
          <div class="inverse-grid">
            <div class="input-group">
              <label for="g-saccharose">Saccharose (g)</label>
              <input type="number" id="g-saccharose" min="0" step="1" value="0" oninput="calculateSugarsInverse()">
            </div>
            <div class="input-group">
              <label for="g-lactose">Lactose (g)</label>
              <input type="number" id="g-lactose" min="0" step="1" value="0" oninput="calculateSugarsInverse()">
            </div>
            <div class="input-group">
              <label for="g-mdx">Maltodextrine (g)</label>
              <input type="number" id="g-mdx" min="0" step="1" value="0" oninput="calculateSugarsInverse()">
            </div>
          </div>

          <div id="inverse-results"></div>
        </div>

        <div class="warning-box">
          <div style="margin-bottom: 8px;">üí° Formules (PPG typiques) :</div>
          <div style="margin-bottom: 4px;">‚Ä¢ Direct : grammes = part √ó Œîpoints √ó (g/point/L) √ó volume(L).</div>
          <div style="margin-bottom: 4px;">‚Ä¢ Inverse : Œîpoints = Œ£ ( grammes / (g/point/L) ) / volume(L).</div>
          <div><strong>‚ö†Ô∏è Fermentation :</strong> seule la fraction saccharose est pleinement fermentescible ‚Üí plus d'ABV / plus sec. Lactose & maltodextrine ajoutent surtout du corps.</div>
        </div>
      </div>
    </div>

    <footer>¬© PATOCHE FOR THE WIN ‚Ä¢ PPG typiques : saccharose 46 ‚Ä¢ lactose 36 ‚Ä¢ maltodextrine 40</footer>
  </div>

  <noscript>
    <div style="background:#fee2e2;border:2px solid #ef4444;color:#991b1b;padding:10px;border-radius:10px;margin:16px 0;">
      JavaScript est d√©sactiv√©, l‚Äôoutil ne peut pas fonctionner.
    </div>
  </noscript>

  <script>
    // ===== Utils (ES5) =====
    function gPerPointPerL(ppg) { return 453.592 / (ppg * 3.78541); }
    function parseOG(input) {
      var s = String(input || '').replace(',', '.').trim();
      if (!s) return NaN;
      if (s.indexOf('.') !== -1) { var v = parseFloat(s); return isFinite(v) ? v : NaN; }
      var asInt = parseInt(s, 10);
      if (!isFinite(asInt)) return NaN;
      if (asInt >= 1000 && asInt <= 2000) return asInt / 1000;
      return asInt;
    }
    function fmt(n, digits) {
      digits = (typeof digits === 'number') ? digits : 2;
      if (!isFinite(n)) return '‚Äî';
      try { return n.toLocaleString('fr-FR', { maximumFractionDigits: digits, minimumFractionDigits: digits }); }
      catch(e){ return (Math.round(n * Math.pow(10,digits))/Math.pow(10,digits)).toString(); }
    }
    function updateSliderLabel(sliderId, labelId){
      var s = document.getElementById(sliderId);
      var l = document.getElementById(labelId);
      if (s && l) l.textContent = s.value + '%';
    }

    // ===== Dark mode (safe storage) =====
    function initDark(){
      try{
        var dark = (typeof localStorage !== 'undefined') && localStorage.getItem('patoche-dark') === '1';
        if (dark) document.body.classList.add('dark');
        var chk = document.getElementById('toggle-dark');
        if (chk) chk.checked = dark;
      }catch(e){}
    }
    function toggleDark(el){
      var on = !!(el && el.checked);
      document.body.classList.toggle('dark', on);
      try{ if (typeof localStorage !== 'undefined') localStorage.setItem('patoche-dark', on ? '1' : '0'); }catch(e){}
    }

    // ===== Tabs & presets =====
    function setVolume(v){
      var el = document.getElementById('volume');
      if (!el) return;
      var num = Math.max(0, parseFloat(String(v).replace(',', '.')));
      el.value = isFinite(num) ? num : '';
      calculate();
    }
    function switchTab(name, btn){
      var tabs = document.querySelectorAll('.tab');
      for (var i=0; i<tabs.length; i++){ tabs[i].classList.remove('active'); }
      if (btn) btn.classList.add('active');
      var contents = document.querySelectorAll('.tab-content');
      for (var j=0; j<contents.length; j++){ contents[j].classList.remove('active'); }
      var div = document.getElementById('tab-' + name);
      if (div) div.classList.add('active');
      calculate();
    }

    // ===== Core calcs =====
    var SUGAR_INFO = {
      saccharose: { gPerPtPerL: gPerPointPerL(46) },
      lactose: { gPerPtPerL: gPerPointPerL(36) },
      maltodextrine: { gPerPtPerL: gPerPointPerL(40) }
    };

    function calculate(){
      calculateDilution();
      var radios = document.getElementsByName('mode-sugar');
      var mode = 'direct';
      for (var i=0; i<radios.length; i++){ if (radios[i].checked) { mode = radios[i].value; break; } }
      if (mode === 'direct') calculateSugarsDirect();
      else calculateSugarsInverse();
    }

    function calculateDilution(){
      var vEl = document.getElementById('volume');
      var ogAEl = document.getElementById('og-actuelle');
      var ogTEl = document.getElementById('og-visee');
      var resultsDiv = document.getElementById('dilution-results');
      if (!vEl || !ogAEl || !ogTEl || !resultsDiv) return;

      var vL = parseFloat(String(vEl.value || '0').replace(',', '.'));
      var ogA = parseOG(ogAEl.value);
      var ogT = parseOG(ogTEl.value);
      var ptsA = isFinite(ogA) ? (ogA - 1) * 1000 : NaN;
      var ptsT = isFinite(ogT) ? (ogT - 1) * 1000 : NaN;

      if (!isFinite(vL) || vL <= 0 || !isFinite(ptsA) || !isFinite(ptsT) || ptsT <= 0 || ptsA <= 0) {
        resultsDiv.innerHTML = '<div class="alert">Renseigne un volume et deux OG valides pour voir le calcul.</div>';
        return;
      }
      if (ptsA <= ptsT) {
        resultsDiv.innerHTML = '<div class="alert">La densit√© actuelle n\'est pas au-dessus de la cible ‚Äî pas de dilution n√©cessaire.</div>';
        return;
      }
      var ratio = ptsA / ptsT;
      var vFinal = vL * ratio;
      var eauAAjouter = vFinal - vL;
      var dilutionIBU = 1 / ratio;

      resultsDiv.innerHTML =
        '<div class="results-grid">'
        + tile('Eau √† ajouter', fmt(eauAAjouter, 2) + ' L', 'utiliser eau d√©soxyg√©n√©e/aseptique')
        + tile('Volume final', fmt(vFinal, 2) + ' L')
        + tile('Facteur de dilution', '√ó ' + fmt(ratio, 3))
        + tile('IBU ‚âà baisse', fmt((1 - dilutionIBU) * 100, 1) + ' %', '(IBU √ó ' + fmt(dilutionIBU, 3) + ')')
        + '</div>';
    }

    function calculateSugarsDirect(){
      var vEl = document.getElementById('volume');
      var ogAS = document.getElementById('og-actuelle-sugar');
      var ogTS = document.getElementById('og-visee-sugar');
      var deltaBox = document.getElementById('delta-points');
      var resultsDiv = document.getElementById('sugar-results');
      if (!vEl || !ogAS || !ogTS || !deltaBox || !resultsDiv) return;

      var vL = parseFloat(String(vEl.value || '0').replace(',', '.'));
      var ogA = parseOG(ogAS.value);
      var ogT = parseOG(ogTS.value);
      var ptsA = isFinite(ogA) ? (ogA - 1) * 1000 : NaN;
      var ptsT = isFinite(ogT) ? (ogT - 1) * 1000 : NaN;
      var deltaPts = (isFinite(ptsA) && isFinite(ptsT)) ? Math.max(0, Math.round(ptsT - ptsA)) : NaN;

      deltaBox.textContent = isFinite(deltaPts) ? '+' + deltaPts + ' pts' : '‚Äî';

      if (!isFinite(vL) || vL <= 0 || !isFinite(deltaPts) || deltaPts <= 0) {
        resultsDiv.innerHTML = '<div class="alert">Renseigne un volume et une paire d\'OG valides (OG vis√©e > OG actuelle) pour voir les masses.</div>';
        return;
      }

      var sSac = document.getElementById('slider-saccharose');
      var sLac = document.getElementById('slider-lactose');
      var sMdx = document.getElementById('slider-mdx');
      var saccharose = sSac ? parseInt(sSac.value,10) : 0;
      var lactose = sLac ? parseInt(sLac.value,10) : 0;
      var mdx = sMdx ? parseInt(sMdx.value,10) : 0;

      var vSac = document.getElementById('value-saccharose');
      var vLac = document.getElementById('value-lactose');
      var vMdx = document.getElementById('value-mdx');
      if (vSac) vSac.textContent = saccharose + '%';
      if (vLac) vLac.textContent = lactose + '%';
      if (vMdx) vMdx.textContent = mdx + '%';

      var total = saccharose + lactose + mdx;
      if (total <= 0) total = 1;
      var mix = { saccharose: saccharose/total, lactose: lactose/total, maltodextrine: mdx/total };

      var grams = {
        saccharose: mix.saccharose * deltaPts * SUGAR_INFO.saccharose.gPerPtPerL * vL,
        lactose: mix.lactose * deltaPts * SUGAR_INFO.lactose.gPerPtPerL * vL,
        maltodextrine: mix.maltodextrine * deltaPts * SUGAR_INFO.maltodextrine.gPerPtPerL * vL
      };
      var totalGrams = grams.saccharose + grams.lactose + grams.maltodextrine;

      resultsDiv.innerHTML =
        '<div class="results-grid">'
        + tile('Total √† dissoudre', fmt(totalGrams, 0) + ' g', '√† ajouter dans ' + fmt(vL, 0) + ' L')
        + tile('Sucre blanc', fmt(grams.saccharose, 0) + ' g', fmt(mix.saccharose * 100, 0) + ' % du mix')
        + tile('Lactose', fmt(grams.lactose, 0) + ' g', fmt(mix.lactose * 100, 0) + ' % du mix')
        + tile('Maltodextrine', fmt(grams.maltodextrine, 0) + ' g', fmt(mix.maltodextrine * 100, 0) + ' % du mix')
        + '</div>';
    }

    function calculateSugarsInverse(){
      var vEl = document.getElementById('volume');
      var ogAEl = document.getElementById('og-actuelle-sugar');
      var resultsDiv = document.getElementById('inverse-results');
      if (!vEl || !ogAEl || !resultsDiv) return;

      var vL = parseFloat(String(vEl.value || '0').replace(',', '.'));
      var ogA = parseOG(ogAEl.value);

      if (!isFinite(vL) || vL <= 0 || !isFinite(ogA)) {
        resultsDiv.innerHTML = '<div class="alert">Renseigne un volume et une OG actuelle valides.</div>';
        return;
      }

      var elGS = document.getElementById('g-saccharose');
      var elGL = document.getElementById('g-lactose');
      var elGM = document.getElementById('g-mdx');
      var gSac = elGS ? parseFloat(elGS.value) || 0 : 0;
      var gLac = elGL ? parseFloat(elGL.value) || 0 : 0;
      var gMdx = elGM ? parseFloat(elGM.value) || 0 : 0;

      var deltaPts = (gSac / SUGAR_INFO.saccharose.gPerPtPerL + gLac / SUGAR_INFO.lactose.gPerPtPerL + gMdx / SUGAR_INFO.maltodextrine.gPerPtPerL) / vL;
      var ogFinale = 1 + (Math.round(((ogA - 1) * 1000 + deltaPts)) / 1000);

      resultsDiv.innerHTML =
        '<div class="results-grid">'
        + tile('Œî points gagn√©s', '+ ' + fmt(deltaPts, 1) + ' pts', 'sur ' + fmt(vL,0) + ' L')
        + tile('OG finale estim√©e', ogFinale.toFixed(3), 'avec OG d√©part ' + (isFinite(ogA) ? ogA.toFixed(3) : '‚Äî'))
        + tile('Total sucre ajout√©', fmt(gSac + gLac + gMdx, 0) + ' g', 'Sacch: ' + fmt(gSac,0) + ' g ‚Ä¢ Lac: ' + fmt(gLac,0) + ' g ‚Ä¢ MDX: ' + fmt(gMdx,0) + ' g')
        + '</div>';
    }

    function toggleSugarMode(){
      var mode = 'direct';
      var radios = document.getElementsByName('mode-sugar');
      for (var i=0; i<radios.length; i++){ if (radios[i].checked) { mode = radios[i].value; break; } }
      document.getElementById('mode-direct').style.display = (mode === 'direct') ? '' : 'none';
      document.getElementById('mode-inverse').style.display = (mode === 'inverse') ? '' : 'none';
      calculate();
    }

    function tile(title, value, sub){
      return '<div class="info-tile">'
        + '<div class="info-tile-title">'+title+'</div>'
        + '<div class="info-tile-value">'+value+'</div>'
        + (sub ? '<div class="info-tile-sub">'+sub+'</div>' : '')
        + '</div>';
    }

    function init(){
      initDark();
      var warn = document.getElementById('js-warning');
      if (warn) { setTimeout(function(){ warn.style.display='none'; }, 1200); }
      calculate();
    }
    // Fallback init if onload blocked
    (function(){ try{ setTimeout(function(){ if (typeof calculate === 'function') calculate(); }, 1500); }catch(e){} })();
  </script>
</body>
</html>
