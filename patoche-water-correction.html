<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Patoche ‚Äì Correction d'eau</title>
<style>
* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  min-height: 100vh;
  padding: 16px;
  color: #1a202c;
}

.container {
  max-width: 1000px;
  margin: 0 auto;
}

header {
  background: white;
  border-radius: 16px;
  padding: 20px 24px;
  margin-bottom: 16px;
  box-shadow: 0 4px 6px rgba(0,0,0,0.07);
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-wrap: wrap;
  gap: 12px;
}

.header-left {
  flex: 1;
}

.status-badge {
  padding: 8px 16px;
  border-radius: 12px;
  font-size: 14px;
  font-weight: 700;
  display: inline-flex;
  align-items: center;
  gap: 8px;
  transition: all 0.3s;
  animation: fadeIn 0.5s;
}

.status-badge.needs-adjustment {
  background: #fee2e2;
  color: #dc2626;
  border: 2px solid #fca5a5;
}

.status-badge.almost-ready {
  background: #fef3c7;
  color: #d97706;
  border: 2px solid #fcd34d;
}

.status-badge.ready {
  background: #d1fae5;
  color: #059669;
  border: 2px solid #6ee7b7;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(-10px); }
  to { opacity: 1; transform: translateY(0); }
}

@keyframes slideIn {
  from { transform: translateX(100%); opacity: 0; }
  to { transform: translateX(0); opacity: 1; }
}

.notification {
  position: fixed;
  top: 20px;
  right: 20px;
  background: white;
  padding: 16px 20px;
  border-radius: 12px;
  box-shadow: 0 10px 25px rgba(0,0,0,0.15);
  z-index: 1000;
  animation: slideIn 0.4s ease-out;
  max-width: 350px;
  border-left: 4px solid #667eea;
}

.notification.success {
  border-left-color: #10b981;
}

.notification-title {
  font-weight: 700;
  margin-bottom: 8px;
  color: #1a202c;
  display: flex;
  align-items: center;
  gap: 8px;
}

.notification-body {
  font-size: 13px;
  color: #4a5568;
  line-height: 1.5;
}

.notification-close {
  position: absolute;
  top: 8px;
  right: 8px;
  cursor: pointer;
  color: #94a3b8;
  font-size: 20px;
  line-height: 1;
  padding: 4px;
}

.notification-close:hover {
  color: #1a202c;
}

h1 {
  font-size: 28px;
  font-weight: 700;
  color: #667eea;
  margin-bottom: 4px;
}

.subtitle {
  color: #718096;
  font-size: 14px;
}

.main-grid {
  display: grid;
  gap: 16px;
  margin-bottom: 16px;
}

@media (min-width: 768px) {
  .main-grid {
    grid-template-columns: 1fr 1fr;
  }
}

.card {
  background: white;
  border-radius: 16px;
  padding: 20px;
  box-shadow: 0 4px 6px rgba(0,0,0,0.07);
}

.card h2 {
  font-size: 18px;
  font-weight: 600;
  margin-bottom: 16px;
  color: #2d3748;
  display: flex;
  align-items: center;
  gap: 8px;
}

.emoji {
  font-size: 20px;
}

.input-group {
  margin-bottom: 16px;
}

.input-group label {
  display: block;
  font-size: 13px;
  font-weight: 500;
  color: #4a5568;
  margin-bottom: 6px;
}

.input-group input[type="number"] {
  width: 100%;
  padding: 10px 12px;
  border: 2px solid #e2e8f0;
  border-radius: 10px;
  font-size: 16px;
  transition: all 0.2s;
  background: #f7fafc;
}

.input-group input[type="number"]:focus {
  outline: none;
  border-color: #667eea;
  background: white;
}

.input-row {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
}

.slider-group {
  margin-bottom: 20px;
}

.slider-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 8px;
}

.slider-label {
  font-size: 13px;
  font-weight: 500;
  color: #4a5568;
}

.slider-value {
  font-size: 16px;
  font-weight: 700;
  color: #667eea;
  min-width: 80px;
  text-align: right;
}

input[type="range"] {
  width: 100%;
  height: 8px;
  border-radius: 10px;
  background: #e2e8f0;
  outline: none;
  -webkit-appearance: none;
}

input[type="range"]::-webkit-slider-thumb {
  -webkit-appearance: none;
  appearance: none;
  width: 20px;
  height: 20px;
  border-radius: 50%;
  background: #667eea;
  cursor: pointer;
  box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}

input[type="range"]::-moz-range-thumb {
  width: 20px;
  height: 20px;
  border-radius: 50%;
  background: #667eea;
  cursor: pointer;
  border: none;
  box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}

.results-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 12px;
  margin-top: 16px;
}

.result-box {
  background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%);
  border-radius: 12px;
  padding: 12px;
  text-align: center;
}

.result-label {
  font-size: 11px;
  font-weight: 600;
  color: #718096;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: 6px;
}

.result-value {
  font-size: 24px;
  font-weight: 700;
  color: #2d3748;
  margin-bottom: 4px;
}

.result-unit {
  font-size: 12px;
  color: #a0aec0;
}

.result-diff {
  font-size: 12px;
  font-weight: 600;
  margin-top: 4px;
}

.result-diff.good {
  color: #48bb78;
}

.result-diff.warning {
  color: #ed8936;
}

.result-diff.bad {
  color: #f56565;
}

.btn-group {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
  margin-top: 12px;
}

.btn {
  padding: 10px 16px;
  border: 2px solid #e2e8f0;
  border-radius: 10px;
  background: white;
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
  color: #4a5568;
}

.btn:hover {
  border-color: #667eea;
  color: #667eea;
  transform: translateY(-1px);
}

.btn-primary {
  background: #667eea;
  border-color: #667eea;
  color: white;
}

.btn-primary:hover {
  background: #5568d3;
  border-color: #5568d3;
  color: white;
}

.dosage-section {
  background: white;
  border-radius: 16px;
  padding: 20px;
  box-shadow: 0 4px 6px rgba(0,0,0,0.07);
}

.dosage-grid {
  display: grid;
  gap: 16px;
  margin-top: 16px;
}

@media (min-width: 768px) {
  .dosage-grid {
    grid-template-columns: 1fr 1fr;
  }
}

.dosage-card {
  background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%);
  border-radius: 12px;
  padding: 16px;
}

.dosage-card h3 {
  font-size: 16px;
  font-weight: 600;
  margin-bottom: 12px;
  color: #2d3748;
}

.dosage-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 10px;
  background: white;
  border-radius: 8px;
  margin-bottom: 8px;
  border: 1px solid #e2e8f0;
  transition: all 0.3s;
}

.dosage-item.has-value {
  border-color: #667eea;
  background: #f0f4ff;
}

.dosage-item.zero-value {
  opacity: 0.5;
}

.dosage-item:last-child {
  margin-bottom: 0;
}

@keyframes pulse {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.05); }
}

.result-value.updating {
  animation: pulse 0.5s ease-in-out;
}

.dosage-name {
  font-size: 13px;
  font-weight: 500;
  color: #4a5568;
}

.dosage-value {
  font-size: 14px;
  font-weight: 700;
  color: #667eea;
}

.dosage-alt {
  font-size: 11px;
  color: #a0aec0;
  margin-top: 2px;
}

.preset-badge {
  display: inline-block;
  padding: 4px 10px;
  background: #667eea20;
  color: #667eea;
  border-radius: 6px;
  font-size: 11px;
  font-weight: 600;
  margin-left: 8px;
}

.volume-controls {
  display: flex;
  gap: 12px;
  align-items: center;
  margin-bottom: 16px;
}

.volume-controls input {
  flex: 1;
}

@media (max-width: 767px) {
  body {
    padding: 12px;
  }
  
  h1 {
    font-size: 24px;
  }
  
  header {
    flex-direction: column;
    align-items: flex-start;
  }
  
  .status-badge {
    width: 100%;
    justify-content: center;
  }
  
  .notification {
    left: 12px;
    right: 12px;
    max-width: none;
  }
  
  .results-grid {
    grid-template-columns: 1fr;
  }
  
  .result-box {
    display: flex;
    justify-content: space-between;
    align-items: center;
    text-align: left;
  }
  
  .result-info {
    flex: 1;
  }
}

.save-preset-section {
  background: #f7fafc;
  border-radius: 12px;
  padding: 16px;
  margin-top: 16px;
}

.preset-input-group {
  display: flex;
  gap: 8px;
  margin-bottom: 12px;
}

.preset-input-group input {
  flex: 1;
  padding: 10px 12px;
  border: 2px solid #e2e8f0;
  border-radius: 10px;
  font-size: 14px;
}

.custom-presets {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
}

.preset-item {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 8px 12px;
  background: white;
  border: 2px solid #667eea;
  border-radius: 10px;
  font-size: 13px;
  font-weight: 600;
  color: #667eea;
  cursor: pointer;
  transition: all 0.2s;
}

.preset-item:hover {
  background: #667eea;
  color: white;
}

.preset-item.editing {
  border-color: #ed8936;
  background: #fef5e7;
}

.preset-edit {
  cursor: pointer;
  color: #667eea;
  font-weight: 700;
  margin-left: 4px;
  font-size: 14px;
}

.preset-item:hover .preset-edit {
  color: white;
}

.preset-item.editing .preset-edit {
  color: #ed8936;
}

.preset-delete {
  cursor: pointer;
  color: #f56565;
  font-weight: 700;
  margin-left: 4px;
}

.preset-item:hover .preset-delete {
  color: white;
}

.preset-item.editing .preset-delete {
  color: #f56565;
}

.preset-values {
  font-size: 11px;
  color: #a0aec0;
  margin-left: auto;
  display: flex;
  gap: 6px;
}

.preset-item:hover .preset-values {
  color: rgba(255, 255, 255, 0.8);
}

.preset-item.editing .preset-values {
  color: #ed8936;
}
</style>
</head>
<body>

<div class="container">
  <header>
    <div class="header-left">
      <h1>üç∫ Patoche ‚Äì Correction d'eau</h1>
      <div class="subtitle">Calcul automatique des ajustements pour votre brassin</div>
    </div>
    <div class="status-badge needs-adjustment" id="statusBadge">
      üî¥ Ajustement n√©cessaire
    </div>
  </header>

  <div class="main-grid">
    <!-- Mesures & Cibles -->
    <div class="card">
      <h2><span class="emoji">üî¨</span> Mesures & Cibles</h2>
      
      <div class="input-group">
        <label>Mesure Salifert (dKH)</label>
        <input type="number" id="salifert" step="0.1" value="9.3">
      </div>
      
      <div class="input-group">
        <label>Alcalinit√© calcul√©e (CaCO‚ÇÉ ppm) <span class="preset-badge">√ó 17.8</span></label>
        <input type="number" id="D13" readonly style="background: #edf2f7; cursor: not-allowed;">
      </div>

      <div class="input-row">
        <div class="input-group">
          <label>SO‚ÇÑ base (ppm)</label>
          <input type="number" id="D16" value="20" step="0.1">
        </div>
        <div class="input-group">
          <label>Cl base (ppm)</label>
          <input type="number" id="D17" value="30" step="0.1">
        </div>
      </div>

      <div class="input-group">
        <label>% Eau osmos√©e (RO)</label>
        <input type="number" id="B3" value="0" min="0" max="100" step="1">
      </div>

      <hr style="border: none; border-top: 1px solid #e2e8f0; margin: 20px 0;">

      <h2 style="font-size: 16px; margin-bottom: 12px;"><span class="emoji">üéØ</span> Profil cible</h2>
      
      <div class="input-row">
        <div class="input-group">
          <label>SO‚ÇÑ cible (ppm)</label>
          <input type="number" id="H24" value="75" step="1">
        </div>
        <div class="input-group">
          <label>Cl cible (ppm)</label>
          <input type="number" id="I24" value="75" step="1">
        </div>
      </div>

      <div class="input-group">
        <label>Alcalinit√© cible (ppm)</label>
        <input type="number" id="J24" value="10" step="0.1">
      </div>

      <div class="save-preset-section">
        <div class="preset-input-group">
          <input type="text" id="presetName" placeholder="Nom du preset...">
          <button class="btn btn-primary" id="savePreset">üíæ Sauvegarder</button>
        </div>
        <div class="custom-presets" id="customPresets"></div>
      </div>
    </div>

    <!-- Ajustements & R√©sultats -->
    <div class="card">
      <h2><span class="emoji">‚öôÔ∏è</span> Ajustements</h2>

      <div class="slider-group">
        <div class="slider-header">
          <span class="slider-label">AMS / CRS (mL/L)</span>
          <span class="slider-value"><span id="outJ31">0.62</span> mL/L</span>
        </div>
        <input type="range" id="J31" min="0" max="2.0" step="0.01" value="0.62">
      </div>

      <div class="slider-group">
        <div class="slider-header">
          <span class="slider-label">Acide Phosphorique 75% (mL/L)</span>
          <span class="slider-value"><span id="outJ32">0.07</span> mL/L</span>
        </div>
        <input type="range" id="J32" min="0" max="1.0" step="0.01" value="0.07">
      </div>

      <div class="slider-group">
        <div class="slider-header">
          <span class="slider-label">CaCl‚ÇÇ (g/L)</span>
          <span class="slider-value"><span id="outC32">0.01</span> g/L</span>
        </div>
        <input type="range" id="C32" min="0" max="1.00" step="0.005" value="0.01">
      </div>

      <div class="slider-group">
        <div class="slider-header">
          <span class="slider-label">Gypse CaSO‚ÇÑ (g/L)</span>
          <span class="slider-value"><span id="outC33">0.00</span> g/L</span>
        </div>
        <input type="range" id="C33" min="0" max="1.00" step="0.005" value="0.00">
      </div>

      <div class="btn-group" style="width: 100%;">
        <button class="btn btn-primary" id="autofitBtn" style="flex: 1;">üéØ Autofit vers cibles</button>
        <button class="btn" id="resetBtn" style="flex: 1;">‚Ü∫ Reset</button>
      </div>

      <hr style="border: none; border-top: 1px solid #e2e8f0; margin: 20px 0;">

      <h2 style="font-size: 16px; margin-bottom: 12px;"><span class="emoji">‚úÖ</span> R√©sultats</h2>
      
      <div class="results-grid">
        <div class="result-box">
          <div class="result-label">SO‚ÇÑ</div>
          <div class="result-value"><span id="H28">‚Äî</span></div>
          <div class="result-unit">ppm</div>
          <div class="result-diff" id="diffSO4">‚Äî</div>
        </div>
        <div class="result-box">
          <div class="result-label">Cl</div>
          <div class="result-value"><span id="I28">‚Äî</span></div>
          <div class="result-unit">ppm</div>
          <div class="result-diff" id="diffCl">‚Äî</div>
        </div>
        <div class="result-box">
          <div class="result-label">CaCO‚ÇÉ</div>
          <div class="result-value"><span id="J28">‚Äî</span></div>
          <div class="result-unit">ppm</div>
          <div class="result-diff" id="diffCaCO3">‚Äî</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Dosages -->
  <div class="dosage-section">
    <h2><span class="emoji">üìä</span> Dosages par volume</h2>
    
    <div class="volume-controls">
      <div class="input-group" style="margin: 0;">
        <label>Volume Emp√¢tage (L)</label>
        <input type="number" id="B42" value="550" step="1">
      </div>
      <div class="input-group" style="margin: 0;">
        <label>Volume Rin√ßage (L)</label>
        <input type="number" id="B45" value="300" step="1">
      </div>
      <button class="btn" id="scenarioA">550/300</button>
      <button class="btn" id="scenarioB">550/400</button>
    </div>

    <div class="dosage-grid">
      <div class="dosage-card">
        <h3>üîµ Emp√¢tage</h3>
        <div class="dosage-item">
          <div class="dosage-name">AMS</div>
          <div style="text-align: right;">
            <div class="dosage-value"><span id="mashAMSg">0</span> g</div>
            <div class="dosage-alt">(<span id="mashAMSml">0</span> mL)</div>
          </div>
        </div>
        <div class="dosage-item">
          <div class="dosage-name">Phosphorique 75%</div>
          <div style="text-align: right;">
            <div class="dosage-value"><span id="mashPHOSg">0</span> g</div>
            <div class="dosage-alt">(<span id="mashPHOSml">0</span> mL)</div>
          </div>
        </div>
        <div class="dosage-item">
          <div class="dosage-name">CaCl‚ÇÇ</div>
          <div>
            <div class="dosage-value"><span id="mashCaCl2g">0</span> g</div>
            <div class="dosage-alt"><span id="mashCaCl2dot2H2Og">0</span> g (CaCl‚ÇÇ¬∑2H‚ÇÇO)</div>
          </div>
        </div>
        <div class="dosage-item">
          <div class="dosage-name">Gypse</div>
          <div>
            <div class="dosage-value"><span id="mashGypsumg">0</span> g</div>
          </div>
        </div>
      </div>

      <div class="dosage-card">
        <h3>üü¢ Rin√ßage</h3>
        <div class="dosage-item">
          <div class="dosage-name">AMS</div>
          <div style="text-align: right;">
            <div class="dosage-value"><span id="spargeAMSg">0</span> g</div>
            <div class="dosage-alt">(<span id="spargeAMSml">0</span> mL)</div>
          </div>
        </div>
        <div class="dosage-item">
          <div class="dosage-name">Phosphorique 75%</div>
          <div style="text-align: right;">
            <div class="dosage-value"><span id="spargePHOSg">0</span> g</div>
            <div class="dosage-alt">(<span id="spargePHOSml">0</span> mL)</div>
          </div>
        </div>
        <div class="dosage-item">
          <div class="dosage-name">CaCl‚ÇÇ</div>
          <div>
            <div class="dosage-value"><span id="spargeCaCl2g">0</span> g</div>
            <div class="dosage-alt"><span id="spargeCaCl2dot2H2Og">0</span> g (CaCl‚ÇÇ¬∑2H‚ÇÇO)</div>
          </div>
        </div>
        <div class="dosage-item">
          <div class="dosage-name">Gypse</div>
          <div>
            <div class="dosage-value"><span id="spargeGypsumg">0</span> g</div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
function clamp(n, min, max) {
  return Math.min(Math.max(n, min), max);
}

function fmt(n, dec = 1) {
  return (Math.round(n * 10 ** dec) / 10 ** dec).toFixed(dec);
}

const els = {
  salifert: document.getElementById("salifert"),
  D13: document.getElementById("D13"),
  D16: document.getElementById("D16"),
  D17: document.getElementById("D17"),
  B3: document.getElementById("B3"),
  H24: document.getElementById("H24"),
  I24: document.getElementById("I24"),
  J24: document.getElementById("J24"),
  J31: document.getElementById("J31"),
  J32: document.getElementById("J32"),
  C32: document.getElementById("C32"),
  C33: document.getElementById("C33"),
  B42: document.getElementById("B42"),
  B45: document.getElementById("B45"),
};

const out = {
  J31: document.getElementById("outJ31"),
  J32: document.getElementById("outJ32"),
  C32: document.getElementById("outC32"),
  C33: document.getElementById("outC33"),
  H28: document.getElementById("H28"),
  I28: document.getElementById("I28"),
  J28: document.getElementById("J28"),
  diffSO4: document.getElementById("diffSO4"),
  diffCl: document.getElementById("diffCl"),
  diffCaCO3: document.getElementById("diffCaCO3"),
  mashAMSml: document.getElementById("mashAMSml"),
  mashAMSg: document.getElementById("mashAMSg"),
  mashPHOSml: document.getElementById("mashPHOSml"),
  mashPHOSg: document.getElementById("mashPHOSg"),
  mashCaCl2g: document.getElementById("mashCaCl2g"),
  mashCaCl2dot2H2Og: document.getElementById("mashCaCl2dot2H2Og"),
  mashGypsumg: document.getElementById("mashGypsumg"),
  spargeAMSml: document.getElementById("spargeAMSml"),
  spargeAMSg: document.getElementById("spargeAMSg"),
  spargePHOSml: document.getElementById("spargePHOSml"),
  spargePHOSg: document.getElementById("spargePHOSg"),
  spargeCaCl2g: document.getElementById("spargeCaCl2g"),
  spargeCaCl2dot2H2Og: document.getElementById("spargeCaCl2dot2H2Og"),
  spargeGypsumg: document.getElementById("spargeGypsumg"),
};

// Load custom presets
let customPresets = [];
try {
  const stored = localStorage.getItem('waterPresets');
  if (stored) {
    customPresets = JSON.parse(stored);
  } else {
    // Default presets if none saved
    customPresets = [
      { name: 'Pale Ale', SO4: 75, Cl: 75, CaCO3: 10 },
      { name: 'IPA', SO4: 100, Cl: 100, CaCO3: 10 },
      { name: 'NEIPA', SO4: 100, Cl: 200, CaCO3: 10 },
      { name: 'Blanche', SO4: 60, Cl: 60, CaCO3: 10 },
      { name: 'Triple', SO4: 75, Cl: 150, CaCO3: 20 }
    ];
    localStorage.setItem('waterPresets', JSON.stringify(customPresets));
  }
} catch (e) {
  customPresets = [
    { name: 'Pale Ale', SO4: 75, Cl: 75, CaCO3: 10 },
    { name: 'IPA', SO4: 100, Cl: 100, CaCO3: 10 },
    { name: 'NEIPA', SO4: 100, Cl: 200, CaCO3: 10 },
    { name: 'Blanche', SO4: 60, Cl: 60, CaCO3: 10 },
    { name: 'Triple', SO4: 75, Cl: 150, CaCO3: 20 }
  ];
}

function saveCustomPresets() {
  try {
    localStorage.setItem('waterPresets', JSON.stringify(customPresets));
  } catch (e) {}
}

let editingPresetIdx = null;

function renderCustomPresets() {
  const container = document.getElementById('customPresets');
  container.innerHTML = '';
  customPresets.forEach((preset, idx) => {
    const div = document.createElement('div');
    div.className = 'preset-item' + (editingPresetIdx === idx ? ' editing' : '');
    div.innerHTML = `
      <span class="preset-name" data-idx="${idx}">${preset.name}</span>
      <span class="preset-values">SO‚ÇÑ:${preset.SO4} Cl:${preset.Cl} Alk:${preset.CaCO3}</span>
      <span class="preset-edit" data-idx="${idx}">‚úèÔ∏è</span>
      <span class="preset-delete" data-idx="${idx}">√ó</span>
    `;
    container.appendChild(div);
  });
}

document.getElementById('customPresets').addEventListener('click', (e) => {
  if (e.target.classList.contains('preset-delete')) {
    const idx = parseInt(e.target.dataset.idx);
    if (confirm(`Supprimer le preset "${customPresets[idx].name}" ?`)) {
      customPresets.splice(idx, 1);
      saveCustomPresets();
      editingPresetIdx = null;
      document.getElementById('presetName').value = '';
      renderCustomPresets();
    }
  } else if (e.target.classList.contains('preset-edit')) {
    const idx = parseInt(e.target.dataset.idx);
    const preset = customPresets[idx];
    
    // Load preset values into form
    document.getElementById('presetName').value = preset.name;
    els.H24.value = preset.SO4;
    els.I24.value = preset.Cl;
    els.J24.value = preset.CaCO3;
    
    editingPresetIdx = idx;
    renderCustomPresets();
    recalc();
  } else if (e.target.classList.contains('preset-name') || e.target.dataset.idx !== undefined) {
    const idx = parseInt(e.target.dataset.idx);
    if (editingPresetIdx === null) {
      // Load preset
      const preset = customPresets[idx];
      els.H24.value = preset.SO4;
      els.I24.value = preset.Cl;
      els.J24.value = preset.CaCO3;
      recalc();
    }
  }
});

document.getElementById('savePreset').addEventListener('click', () => {
  const name = document.getElementById('presetName').value.trim();
  if (!name) {
    alert('Veuillez entrer un nom pour le preset');
    return;
  }
  
  const presetData = {
    name,
    SO4: parseFloat(els.H24.value),
    Cl: parseFloat(els.I24.value),
    CaCO3: parseFloat(els.J24.value),
  };
  
  if (editingPresetIdx !== null) {
    // Update existing preset
    customPresets[editingPresetIdx] = presetData;
    editingPresetIdx = null;
  } else {
    // Add new preset
    customPresets.push(presetData);
  }
  
  saveCustomPresets();
  renderCustomPresets();
  document.getElementById('presetName').value = '';
});

function recalc() {
  const sal = parseFloat(els.salifert.value || 0);
  const D13 = sal * 17.8;
  els.D13.value = fmt(D13, 1);

  const B3 = clamp(parseFloat(els.B3.value || 0), 0, 100);
  const B16 = parseFloat(els.D16.value || 0) * ((100 - B3) / 100);
  const B17 = parseFloat(els.D17.value || 0) * ((100 - B3) / 100);
  const B13 = D13 * ((100 - B3) / 100);

  const H24 = parseFloat(els.H24.value || 0);
  const I24 = parseFloat(els.I24.value || 0);
  const J24 = parseFloat(els.J24.value || 0);

  const J31 = parseFloat(els.J31.value || 0);
  const J32 = parseFloat(els.J32.value || 0);
  const C32 = parseFloat(els.C32.value || 0);
  const C33 = parseFloat(els.C33.value || 0);

  out.J31.textContent = J31.toFixed(2);
  out.J32.textContent = J32.toFixed(2);
  out.C32.textContent = C32.toFixed(3);
  out.C33.textContent = C33.toFixed(3);

  const D32 = C32 * 1000;
  const D33 = C33 * 1000;
  const F32 = D32 * 0.64;
  const F33 = D33 * 0.557;
  const F34 = 0;
  const F37 = 0;
  const J34 = 0;
  const J33 = 0;
  const J35 = 0;
  const G35 = 0;
  const G36 = 0;

  const H27 = (J31 * 89) + (J33 * 2 * 96) + F33 + F37;
  const I27 = (J31 * 63) + F32 + (J34 * 2 * 35.5) + F34;
  const J27 = (-J31 * 182.9) + (-J32 * 602) + (-J35 * 538) + (-J33 * 201.7) + (-J34 * 100.8) + G35 + G36;

  const H28 = B16 + H27;
  const I28 = B17 + I27;
  const J28 = B13 + J27;

  out.H28.textContent = fmt(H28, 1);
  out.I28.textContent = fmt(I28, 1);
  out.J28.textContent = fmt(J28, 1);

  const dSO4 = H28 - H24;
  const dCl = I28 - I24;
  const dCaC = J28 - J24;

  function paintDiff(el, v) {
    const abs = Math.abs(v);
    el.textContent = (v > 0 ? '+' : '') + fmt(v, 1);
    if (abs <= 5) {
      el.className = 'result-diff good';
    } else if (abs <= 15) {
      el.className = 'result-diff warning';
    } else {
      el.className = 'result-diff bad';
    }
  }

  paintDiff(out.diffSO4, dSO4);
  paintDiff(out.diffCl, dCl);
  paintDiff(out.diffCaCO3, dCaC);
  
  // Add pulse animation to result values
  [out.H28, out.I28, out.J28].forEach(el => {
    el.classList.add('updating');
    setTimeout(() => el.classList.remove('updating'), 500);
  });

  const B42 = parseFloat(els.B42.value || 0);
  const B45 = parseFloat(els.B45.value || 0);

  const C42 = J31 * B42;
  const E42 = C42 * 1.086;
  const C43 = J32 * B42;
  const F43 = C43 * 1.58;
  const C44 = B42 * C32;
  const C45 = B42 * C33;
  const CaCl2dot2H2O_mash = C44 / 0.77;

  out.mashAMSg.textContent = fmt(E42, 1);
  out.mashAMSml.textContent = fmt(C42, 1);
  out.mashPHOSg.textContent = fmt(F43, 1);
  out.mashPHOSml.textContent = fmt(C43, 1);
  out.mashCaCl2g.textContent = fmt(C44, 1);
  out.mashCaCl2dot2H2Og.textContent = fmt(CaCl2dot2H2O_mash, 1);
  out.mashGypsumg.textContent = fmt(C45, 1);

  const I42 = B45 * J31;
  const K42 = I42 * 1.086;
  const I43 = B45 * J32;
  const K43 = I43 * 1.58;
  const I44 = B45 * C32;
  const I45 = B45 * C33;
  const CaCl2dot2H2O_sparge = I44 / 0.77;

  out.spargeAMSg.textContent = fmt(K42, 1);
  out.spargeAMSml.textContent = fmt(I42, 1);
  out.spargePHOSg.textContent = fmt(K43, 1);
  out.spargePHOSml.textContent = fmt(I43, 1);
  out.spargeCaCl2g.textContent = fmt(I44, 1);
  out.spargeCaCl2dot2H2Og.textContent = fmt(CaCl2dot2H2O_sparge, 1);
  out.spargeGypsumg.textContent = fmt(I45, 1);
  
  // Update dosage item visual states
  updateDosageVisuals();
  
  // Update global status badge
  updateStatusBadge();
}

function updateDosageVisuals() {
  // Get all dosage items
  const allDosageItems = document.querySelectorAll('.dosage-item');
  
  // Mash section (first 4 items)
  const mashAMS = allDosageItems[0];
  const mashPhos = allDosageItems[1];
  const mashCaCl2 = allDosageItems[2];
  const mashGypsum = allDosageItems[3];
  
  // Sparge section (last 4 items)
  const spargeAMS = allDosageItems[4];
  const spargePhos = allDosageItems[5];
  const spargeCaCl2 = allDosageItems[6];
  const spargeGypsum = allDosageItems[7];
  
  const items = [
    { el: mashAMS, value: parseFloat(out.mashAMSg.textContent) },
    { el: mashPhos, value: parseFloat(out.mashPHOSg.textContent) },
    { el: mashCaCl2, value: parseFloat(out.mashCaCl2g.textContent) },
    { el: mashGypsum, value: parseFloat(out.mashGypsumg.textContent) },
    { el: spargeAMS, value: parseFloat(out.spargeAMSg.textContent) },
    { el: spargePhos, value: parseFloat(out.spargePHOSg.textContent) },
    { el: spargeCaCl2, value: parseFloat(out.spargeCaCl2g.textContent) },
    { el: spargeGypsum, value: parseFloat(out.spargeGypsumg.textContent) }
  ];
  
  items.forEach(item => {
    if (!item.el) return;
    if (item.value > 0.01) {
      item.el.classList.add('has-value');
      item.el.classList.remove('zero-value');
    } else {
      item.el.classList.remove('has-value');
      item.el.classList.add('zero-value');
    }
  });
}

function updateStatusBadge() {
  const statusBadge = document.getElementById('statusBadge');
  if (!statusBadge) return;
  
  const dSO4 = Math.abs(parseFloat(out.H28.textContent) - parseFloat(els.H24.value || 0));
  const dCl = Math.abs(parseFloat(out.I28.textContent) - parseFloat(els.I24.value || 0));
  const dCaCO3 = Math.abs(parseFloat(out.J28.textContent) - parseFloat(els.J24.value || 0));
  
  const tolerance = 5;
  const allGood = dSO4 <= tolerance && dCl <= tolerance && dCaCO3 <= tolerance;
  const almostGood = (dSO4 <= tolerance * 2) && (dCl <= tolerance * 2) && (dCaCO3 <= tolerance * 2);
  
  if (allGood) {
    statusBadge.className = 'status-badge ready';
    statusBadge.innerHTML = 'üü¢ Pr√™t √† brasser !';
  } else if (almostGood) {
    statusBadge.className = 'status-badge almost-ready';
    statusBadge.innerHTML = 'üü° Presque bon';
  } else {
    statusBadge.className = 'status-badge needs-adjustment';
    statusBadge.innerHTML = 'üî¥ Ajustement n√©cessaire';
  }
}

function showNotification(title, message, type = 'success') {
  // Remove existing notification
  const existing = document.querySelector('.notification');
  if (existing) existing.remove();
  
  const notification = document.createElement('div');
  notification.className = `notification ${type}`;
  notification.innerHTML = `
    <span class="notification-close">√ó</span>
    <div class="notification-title">${title}</div>
    <div class="notification-body">${message}</div>
  `;
  
  document.body.appendChild(notification);
  
  notification.querySelector('.notification-close').addEventListener('click', () => {
    notification.remove();
  });
  
  setTimeout(() => {
    if (notification.parentNode) notification.remove();
  }, 5000);
}

['input', 'change'].forEach(evt => {
  document.body.addEventListener(evt, (e) => {
    if (e.target && e.target.id && (els[e.target.id] || e.target.type === 'range')) {
      recalc();
    }
  });
});

document.getElementById('resetBtn').addEventListener('click', () => {
  els.J31.value = 0;
  els.J32.value = 0;
  els.C32.value = 0;
  els.C33.value = 0;
  recalc();
});

document.getElementById('autofitBtn').addEventListener('click', () => {
  const targetSO4 = parseFloat(els.H24.value || 0);
  const targetCl = parseFloat(els.I24.value || 0);
  const targetCaCO3 = parseFloat(els.J24.value || 0);
  const tolerance = 2;
  
  // Get base values after RO
  const sal = parseFloat(els.salifert.value || 0);
  const D13 = sal * 17.8;
  const B3 = clamp(parseFloat(els.B3.value || 0), 0, 100);
  const B16 = parseFloat(els.D16.value || 0) * ((100 - B3) / 100);
  const B17 = parseFloat(els.D17.value || 0) * ((100 - B3) / 100);
  const B13 = D13 * ((100 - B3) / 100);
  
  // Step 1: Use AMS but STOP when we reach ANY of the three targets
  let bestJ31 = 0;
  
  for (let j31 = 0; j31 <= 2.0; j31 += 0.01) {
    const J27_ams = -j31 * 182.9;
    const H27_ams = j31 * 89;   // SO4 from AMS
    const I27_ams = j31 * 63;   // Cl from AMS
    
    const resultCaCO3 = B13 + J27_ams;
    const resultSO4 = B16 + H27_ams;
    const resultCl = B17 + I27_ams;
    
    // Check if we've reached or exceeded ANY target
    const reachedCaCO3 = resultCaCO3 <= targetCaCO3;
    const reachedSO4 = resultSO4 >= targetSO4;
    const reachedCl = resultCl >= targetCl;
    
    // Stop if we reach any target
    if (reachedCaCO3 || reachedSO4 || reachedCl) {
      bestJ31 = j31;
      break;
    }
    
    bestJ31 = j31;
  }
  
  // Step 2: Fine-tune alkalinity with Phosphoric (doesn't affect SO4/Cl)
  let bestJ32 = 0;
  let J27_ams = -bestJ31 * 182.9;
  let currentCaCO3 = B13 + J27_ams;
  
  if (currentCaCO3 > targetCaCO3 + tolerance) {
    for (let j32 = 0; j32 <= 1.0; j32 += 0.01) {
      const J27_phos = -j32 * 602;
      const resultCaCO3 = B13 + J27_ams + J27_phos;
      
      if (Math.abs(resultCaCO3 - targetCaCO3) <= tolerance) {
        bestJ32 = j32;
        break;
      }
      
      if (resultCaCO3 <= targetCaCO3) {
        bestJ32 = j32;
        break;
      }
      
      bestJ32 = j32;
    }
  }
  
  els.J31.value = bestJ31.toFixed(2);
  els.J32.value = bestJ32.toFixed(2);
  
  // Step 3: Fine-tune SO4 and Cl with salts
  const H27_acids = bestJ31 * 89;
  const I27_acids = bestJ31 * 63;
  
  const currentSO4_noSalts = B16 + H27_acids;
  const currentCl_noSalts = B17 + I27_acids;
  
  let bestC32 = 0, bestC33 = 0;
  let bestIonDiff = Infinity;
  
  // Search for best salt combination
  for (let c33 = 0; c33 <= 1.0; c33 += 0.005) {
    for (let c32 = 0; c32 <= 1.0; c32 += 0.005) {
      const D32 = c32 * 1000;
      const D33 = c33 * 1000;
      const F32 = D32 * 0.64;
      const F33 = D33 * 0.557;
      
      const resultSO4 = currentSO4_noSalts + F33;
      const resultCl = currentCl_noSalts + F32;
      
      const diffSO4 = Math.abs(resultSO4 - targetSO4);
      const diffCl = Math.abs(resultCl - targetCl);
      const totalDiff = diffSO4 + diffCl;
      
      if (totalDiff < bestIonDiff) {
        bestIonDiff = totalDiff;
        bestC32 = c32;
        bestC33 = c33;
      }
      
      if (diffSO4 <= tolerance && diffCl <= tolerance) break;
    }
    
    const D32 = bestC32 * 1000;
    const D33 = bestC33 * 1000;
    const F32 = D32 * 0.64;
    const F33 = D33 * 0.557;
    const resultSO4 = currentSO4_noSalts + F33;
    const resultCl = currentCl_noSalts + F32;
    
    if (Math.abs(resultSO4 - targetSO4) <= tolerance && 
        Math.abs(resultCl - targetCl) <= tolerance) break;
  }
  
  els.C32.value = bestC32.toFixed(3);
  els.C33.value = bestC33.toFixed(3);
  
  recalc();
});

document.getElementById('scenarioA').addEventListener('click', () => {
  els.B42.value = 550;
  els.B45.value = 300;
  recalc();
});

document.getElementById('scenarioB').addEventListener('click', () => {
  els.B42.value = 550;
  els.B45.value = 400;
  recalc();
});

// Load saved state
try {
  const saved = localStorage.getItem('waterState');
  if (saved) {
    const state = JSON.parse(saved);
    Object.keys(state).forEach(key => {
      if (els[key]) els[key].value = state[key];
    });
  }
} catch (e) {}

// Save state on change
function saveState() {
  try {
    const state = {};
    Object.keys(els).forEach(key => {
      state[key] = els[key].value;
    });
    localStorage.setItem('waterState', JSON.stringify(state));
  } catch (e) {}
}

document.body.addEventListener('change', saveState);

// Initialize
renderCustomPresets();
recalc();
</script>
</body>
</html>